<mat-card class="plantao-list-container">
  <mat-card-header>
    <mat-card-title>{{ isMedico ? 'Meus Plantões' : 'Gerenciar Plantões' }}</mat-card-title>
    <span class="header-spacer"></span>
    <button
      *ngIf="isAdminOrEscalista"
      mat-flat-button
      color="primary"
      routerLink="/dashboard/plantoes/criar"
    >
      <mat-icon>add</mat-icon>
      Criar Novo Plantão
    </button>
  </mat-card-header>

  <mat-card-content>
    <div *ngIf="isLoading" class="loading-overlay">
      <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
      <p>Carregando plantões...</p>
    </div>

    <div *ngIf="!isLoading && errorMessage" class="error-message">
      {{ errorMessage }}
    </div>

    <div *ngIf="!isLoading && !errorMessage && isMedico" class="table-section">
      <h3>Meus Plantões</h3>
      <div *ngIf="meusPlantoes.length > 0; else noPlantoesMedico">
        <div class="table-responsive-wrapper">
          <table mat-table [dataSource]="meusPlantoes" class="mat-elevation-z8 plantao-table">
            <ng-container matColumnDef="hospitalNome">
              <th mat-header-cell *matHeaderCellDef>Hospital</th>
              <td mat-cell *matCellDef="let plantao">{{ plantao.nomeHospital }}</td>
            </ng-container>

            <ng-container matColumnDef="especialidade">
              <th mat-header-cell *matHeaderCellDef>Especialidade</th>
              <td mat-cell *matCellDef="let plantao">{{ plantao.especialidadeNome || 'N/A' }}</td>
            </ng-container>

            <ng-container matColumnDef="inicio">
              <th mat-header-cell *matHeaderCellDef>Início</th>
              <td mat-cell *matCellDef="let plantao">
                {{ plantao.inicio | date : 'dd/MM/yyyy HH:mm' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="fim">
              <th mat-header-cell *matHeaderCellDef>Fim</th>
              <td mat-cell *matCellDef="let plantao">
                {{ plantao.fim | date : 'dd/MM/yyyy HH:mm' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="valor">
              <th mat-header-cell *matHeaderCellDef>Valor</th>
              <td mat-cell *matCellDef="let plantao">{{ plantao.valor | currency : 'BRL' }}</td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let plantao">
                <p-tag
                  [value]="formatStatus(plantao.status)"
                  [severity]="getSeverity(plantao.status)"
                ></p-tag>
              </td>
            </ng-container>

            <ng-container matColumnDef="acoes">
              <th mat-header-cell *matHeaderCellDef>Ações</th>
              <td mat-cell *matCellDef="let plantao" class="coluna-acoes">
                <button
                  mat-icon-button
                  (click)="verDetalhesPlantao(plantao.id)"
                  matTooltip="Ver Detalhes"
                  aria-label="Ver detalhes do plantão"
                >
                  <mat-icon>visibility</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumnsMedico"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsMedico"></tr>
          </table>
        </div>
      </div>
      <ng-template #noPlantoesMedico>
        <div class="no-results-message">
          <p>Você ainda não possui plantões cadastrados.</p>
        </div>
      </ng-template>
    </div>

    <div *ngIf="!isLoading && !errorMessage && isAdminOrEscalista" class="table-section">
      <h3>Todos os Plantões</h3>
      <ng-container *ngIf="!isLoading && isAdminOrEscalista && plantoesPaginados as pagina">
        <div *ngIf="pagina.content && pagina.content.length > 0; else noPlantoesAdmin">
          <div class="table-responsive-wrapper">
            <table mat-table [dataSource]="pagina.content" class="mat-elevation-z8 plantao-table">
              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef>ID</th>
                <td mat-cell *matCellDef="let plantao">{{ plantao.id }}</td>
              </ng-container>

              <ng-container matColumnDef="hospitalNome">
                <th mat-header-cell *matHeaderCellDef>Hospital</th>
                <td mat-cell *matCellDef="let plantao">{{ plantao.nomeHospital }}</td>
              </ng-container>

              <ng-container matColumnDef="especialidade">
                <th mat-header-cell *matHeaderCellDef>Especialidade</th>
                <td mat-cell *matCellDef="let plantao">{{ plantao.especialidadeNome || 'N/A' }}</td>
              </ng-container>

              <ng-container matColumnDef="inicio">
                <th mat-header-cell *matHeaderCellDef>Início</th>
                <td mat-cell *matCellDef="let plantao">
                  {{ plantao.inicio | date : 'dd/MM/yyyy HH:mm' }}
                </td>
              </ng-container>
              <ng-container matColumnDef="fim">
                <th mat-header-cell *matHeaderCellDef>Fim</th>
                <td mat-cell *matCellDef="let plantao">
                  {{ plantao.fim | date : 'dd/MM/yyyy HH:mm' }}
                </td>
              </ng-container>

              <ng-container matColumnDef="valor">
                <th mat-header-cell *matHeaderCellDef>Valor</th>
                <td mat-cell *matCellDef="let plantao">{{ plantao.valor | currency : 'BRL' }}</td>
              </ng-container>

              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let plantao">
                  <p-tag
                    [value]="formatStatus(plantao.status)"
                    [severity]="getSeverity(plantao.status)"
                  ></p-tag>
                </td>
              </ng-container>

              <ng-container matColumnDef="medicoNome">
                <th mat-header-cell *matHeaderCellDef>Médico</th>
                <td mat-cell *matCellDef="let plantao">{{ plantao.nomeMedico || 'N/A' }}</td>
              </ng-container>

              <ng-container matColumnDef="acoes">
                <th mat-header-cell *matHeaderCellDef>Ações</th>
                <td mat-cell *matCellDef="let plantao" class="coluna-acoes">
                  <button
                    mat-icon-button
                    (click)="verDetalhesPlantao(plantao.id)"
                    matTooltip="Ver Detalhes"
                    aria-label="Ver detalhes do plantão"
                  >
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    (click)="editarPlantao(plantao.id)"
                    matTooltip="Editar"
                    aria-label="Editar plantão"
                  >
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    (click)="excluirPlantao(plantao.id)"
                    matTooltip="Excluir"
                    aria-label="Excluir plantão"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumnsAdmin"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumnsAdmin"></tr>
            </table>
          </div>

          <mat-paginator
            [length]="pagina.totalElements"
            [pageSize]="pagina.size"
            [pageSizeOptions]="[5, 10, 20]"
            (page)="onPageChange($event)"
            aria-label="Selecionar página"
            class="mat-elevation-z8 custom-paginator"
          >
          </mat-paginator>
        </div>
      </ng-container>

      <ng-template #noPlantoesAdmin>
        <div class="no-results-message">
          <p>Não há plantões disponíveis para gerenciar no momento.</p>
        </div>
      </ng-template>
    </div>
  </mat-card-content>
</mat-card>
